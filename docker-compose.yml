services:
  app:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: urbanmart-app
    restart: unless-stopped
    depends_on:
      - db
      - redis
    env_file:
      - ./api/.env.prod
    volumes:
      - storage-data:/usr/share/nginx/html/storage
    networks:
      - urbanmart-network
    
  queue-worker:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: urbanmart-queue
    restart: unless-stopped
    command: php artisan queue:work redis --queue=scout,default --sleep=1 --tries=3 --timeout=90 --max-time=3600
    environment:
      IS_WORKER: "true"
    env_file:
      - ./api/.env.prod
    depends_on:
      - db
      - redis
      - typesense
      - app
    volumes:
      - storage-data:/usr/share/nginx/html/storage
    networks:
      - urbanmart-network

  scheduler:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: urbanmart-scheduler
    restart: unless-stopped
    command: php artisan schedule:work
    env_file:
      - ./api/.env.prod
    depends_on:
      - db
      - redis
      - app
    volumes:
      - storage-data:/usr/share/nginx/html/storage
    networks:
      - urbanmart-network
    
  nginx:
    image: nginx:1-alpine
    container_name: urbanmart-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - app
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - urbanmart-network
      
  db:
    image: bitnami/postgresql:latest
    container_name: urbanmart-db
    restart: always
    ports:
      - "5432:5432"
    volumes:
      - db-data:/bitnami/postgresql
    environment:
      - POSTGRESQL_DATABASE=${POSTGRESQL_DATABASE:-urbanmart}
      - POSTGRESQL_USERNAME=${POSTGRESQL_USERNAME:-postgres}
      - POSTGRESQL_PASSWORD=${POSTGRESQL_PASSWORD:-secret}
    networks:
      - urbanmart-network
      
  redis:
    image: bitnami/redis:latest
    container_name: urbanmart-redis
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/bitnami/redis/data
    environment:
      - ALLOW_EMPTY_PASSWORD=no
      - REDIS_PASSWORD=${REDIS_PASSWORD:-redissecret}
      - REDIS_DISABLE_COMMANDS=FLUSHDB,FLUSHALL
    networks:
      - urbanmart-network

  typesense:
    image: typesense/typesense:29.0
    container_name: urbanmart-typesense
    restart: unless-stopped
    ports:
      - "8108:8108"
    volumes:
      - ./typesense-data:/data
    command: >
      --data-dir /data
      --api-key=${TYPESENSE_API_KEY}
      --enable-cors
    networks:
      - urbanmart-network

  client:
    build:
      context: ./client
      dockerfile: Dockerfile
    container_name: urbanmart-client
    restart: unless-stopped
    ports:
      - "5173:5173"
    volumes:
      - ./client:/app
      - /app/node_modules
    environment:
      - CHOKIDAR_USEPOLLING=true
    env_file:
      - ./client/.env.prod
    networks:
      - urbanmart-network

volumes:
  storage-data:
    driver: local
  db-data:
    driver: local
  redis-data:
    driver: local

networks:
  urbanmart-network:
    driver: bridge